pipeline {
    agent any
    
    environment {
        AWS_KEY_ID = credentials('AWS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        AWS_BUCKET = 'arn:aws:s3:::dev2.wisersell.com'
        SLACK_WEBHOOK_URL = 'https://hooks.slack.com/services/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'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        podTemplate(containers: [
            containerTemplate(name: 'maven', image: 'maven:3-amazoncorretto-21', command: 'sleep', args: '99d'),
            containerTemplate(name: 'golang', image: 'golang:1.16.5', command: 'sleep', args: '99d'),
            containerTemplate(name: 'amazoncorretto', image: 'amazoncorretto:8u412-alpine3.19-jre', command: 'sleep', args: '99d')
        ]) {
            node(POD_LABEL) {
                stage('Get a Maven project') {
                    git 'https://github.com/jenkinsci/kubernetes-plugin.git'
                    container('maven') {
                        stage('Build a Maven project') {
                            sh 'mvn -B -ntp clean install'
                        }
                    }
                }
                // Diğer aşamalar buraya eklenebilir
            }        
        stage('Set up JDK 19') {
            steps {
                script {
                    tool 'jdk-19' // Assuming JDK 19 is configured in Jenkins as a tool
                }
            }
        }
        
        stage('Test with Maven') {
            steps {
                sh 'mvn -B package --file pom.xml'
            }
        }
        
        stage('Upload Test Results to S3') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', accessKeyVariable: 'AWS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                    sh 'aws s3 cp target s3://${AWS_BUCKET}/target --recursive'
                }
            }
        }
        
        stage('Slack Notification') {
            when {
                expression {
                    currentBuild.result != null
                }
            }
            steps {
                script {
                    def status = currentBuild.result
                    def objectKey = sh(script: 'echo $S3_OBJECT_KEY', returnStdout: true).trim()
                    def slackMessage = "Testing ${env.GITHUB_REF_NAME} branch for VERSION-2 AUTOMATION TESTS\n" +
                                       "https://dev2.wisersell.com.s3.us-east-1.amazonaws.com/${objectKey}/html-reports/Run_Smoke_Test.html"
                    
                    slackSend color: status == 'SUCCESS' ? 'good' : 'danger',
                              message: slackMessage,
                              channel: 'version-2-notification',
                              teamDomain: 'your-slack-workspace-domain',
                              tokenCredentialId: 'slack-token'
                }
            }
        }
    }
}
